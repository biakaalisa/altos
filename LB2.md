**Лабораторная работа №2: резервное копирование, восстановление и 
мониторинг в Debian и PostgreSQL** 

Изучить способы резервного копирования баз данных PostgreSQL и восстановления 
их в среде Debian. Освоить базовые инструменты мониторинга системы и сервиса 
PostgreSQL. 

# 1. Утилиты резервного копирования 
### Изучить и сравнить pg_dump и pg_basebackup. Описать сценарии применения каждой утилиты.

pg_dump: Логический бэкап (SQL), отдельных БД/таблиц, медленное восстановление, межверсионная совместимость. Утилита для создания логических дампов отдельных баз данных PostgreSQL. Она извлекает данные в виде SQL-команд, которые можно выполнить для восстановления базы.

pg_basebackup: Физический бэкап (бинарный), всего кластера, быстрое восстановление, только для той же версии. Утилита для создания физических бэкапов всего кластера PostgreSQL (всех баз данных). Она копирует бинарные файлы данных с сервера, создавая полную копию на момент бэкапа.

**Когда использовать?**

pg_dump:
 - Бэкап отдельных БД/таблиц
 - Перенос между версиями PostgreSQL
 - Экспорт структуры без данных
 - Малые/средние БД

pg_basebackup:
 - Полный бэкап кластера
 - Настройка репликации
 - Быстрое восстановление (Disaster Recovery)
 - Развертывание идентичных сред
 - Требует соответсвующих прав от пользователя ```CREATE USER backup_user WITH REPLICATION LOGIN PASSWORD 'secure_password';```

# 2. Создание резервной копии 
### Выполнить полное резервное копирование (dump) базы данных из лаб. №1. Использовать параметры (например, -Fc, -Ft, обязательно посмотреть другие параметры!), объяснить разницу. 

Plain (текстовый SQL) – -Fp (по умолчанию)
- Вывод в виде читаемого SQL-скрипта
- Нет сжатия (размер бэкапа ≈ размеру данных в БД)
- Можно редактировать вручную перед восстановлением
- Подходит для мелких БД или переноса между разными версиями PostgreSQL
  
        pg_dump -U user -d dbname -Fp -f backup.sql

Custom (бинарный) – -Fc
- Бинарный формат со сжатием (экономит место)
- Поддержка параллельного восстановления (pg_restore -j N)
- Возможность выборочного восстановления объектов
- Самый быстрый для больших БД

        pg_dump -U user -d dbname -Fc -f backup.dump

Directory (каталог) – -Fd

 - Создает каталог с отдельными файлами для каждой таблицы
 - Поддержка многопоточности при дампе (-j N)
 - Автоматическое сжатие (как в Custom)
 - Удобен для частичного восстановления

         pg_dump -U user -d dbname -Fd -f backup_dir/

Tar (архив) – -Ft
 - Создает .tar-архив (можно распаковать стандартными утилитами)
 - Каждая таблица – отдельный файл в архиве
 - Поддержка сжатия через -Z (gzip) или --compress=0-9
 - Ограничение: размер файла не должен превышать 8 GB
   
       pg_dump -U user -d dbname -Ft -f backup.tar
   
![image](https://github.com/user-attachments/assets/000aa149-2bd0-4734-a3dd-7ddb958238de)

Для создания полной копии БД будем использовать команду

    pg_dump -U postgres -d postgres -Fp -f backup.sql

![image](https://github.com/user-attachments/assets/1974f3c3-b228-4510-ae32-5e1a0137f131)
![image](https://github.com/user-attachments/assets/75bd187c-e585-496a-9d5b-77dd0559cfc4)
 

Команда для восстановления:

    psql -U user -d new_dbname -f backup.sql

# 3. Частичное (выборочное) резервное копирование 
### Сделать дамп только определённой схемы (например, test_schema, созданной в ЛР №1). Сделать дамп только определённых таблиц из схемы public. Объяснить, в чём отличие от резервного копирования всей базы.    

Для резервного копирования отдельных схем или таблиц используется ```pg_dump``` с параметрами выбора объектов. Это отличается от полного бэкапа базы ```(pg_dump -d dbname)``` тем, что сохраняются только указанные данные, что экономит место и время.

![image](https://github.com/user-attachments/assets/2f343eab-cce4-47f7-8ca1-14b5e6a5dd89)
![image](https://github.com/user-attachments/assets/7ba767da-3217-4d26-8c5d-bde908befd2e)
![image](https://github.com/user-attachments/assets/8c70596e-b931-42ba-aed5-2bad0a617040)

![image](https://github.com/user-attachments/assets/b2a1d408-5b37-4821-84c8-8dae08cd64c0)

Скопируем только схему test_schema, соxраняя данные внутри нее при помощи:

    pg_dump -U postgres -d postgres -n test_schema -Fc -f test_schema.dump

 + -U postgres - делаем копирование от имени пользователя postgres
 + -d postgres - копируем схему из бд postgres
 + -n test_schema — дамп только схемы test_schema
 + -Fc — бинарный формат (используем только его, т.к. в лабораторной работе есть пунктик о восстановлении определенной таблицы, и именно данный режим наиболее удобен для точечноговосстановления элементов)
 + -f test_schema.dump — сохранение в файл

![image](https://github.com/user-attachments/assets/34056062-44d7-4b5b-831d-1af53b30ff8e)

Скопируем таблицу t_t из схемы test_schema при помощи команды:

    pg_dump -U postgres -d postgres -t test_schema.t_t -Fc -f public-test.dump

 ![image](https://github.com/user-attachments/assets/2b5e3cdb-6361-455e-9ea1-76cd63fc3ae9)


# 4. Восстановление из резервной копии 
### Восстановить базу из резервного файла с помощью pg_restore или утилиты psql. Продемонстрировать процесс и результаты. 

Перед восстановлением базы обязательно нужно создать пустую БД, в которую вудет все записано

      psql -U postgres -c "CREATE DATABASE restored_db;"

Для восстановления базы можно использовать одну из двух команд:
- pg_restore. Подходит для восстановления бинарных дампов (-Fc  или  -Fd )
- psql -f. Для восстановления из текстовых SQL-дампов (-Fp)
  
![image](https://github.com/user-attachments/assets/80d55245-fd83-4c3e-9e05-7ce7dbaf5690)

![image](https://github.com/user-attachments/assets/5dbdad1a-7c38-4eb1-bb60-0aed14132862)

Т.к. бэкап базы делали при помощи -Fp, восстанавливать будем командой:

    psql -U postgres -d restored_db -f backup.sql

![image](https://github.com/user-attachments/assets/4f02ce70-fb10-4a26-98b4-a5c21aaef234)

# 5. Автоматизация бэкапов с помощью cron 
### Настроить планировщик cron на Debian, чтобы ежедневно создавать резервные копии. Указать, куда складываются дампы, и как выполняется ротация. Обязательно понимать, что такое ротация!     

Cron — это демон (фоновый процесс), который выполняет задачи по расписанию. Он используется для автоматизации рутинных операций: бэкапов, обновлений, очистки логов и других периодических действий.

     * * * * * команда_для_запуска
     │ │ │ │ │
     │ │ │ │ └─── День недели (0–7, 0 и 7 = воскресенье)
     │ │ │ └───── Месяц (1–12)
     │ │ └─────── День месяца (1–31)
     │ └───────── Час (0–23)
     └─────────── Минута (0–59)

![image](https://github.com/user-attachments/assets/8c564ff1-af06-42b2-bec6-302eb6bfb896)

Для редактирования системного crontab-файла, который как раз-таки отвечает за выполнение в определенное время какмх либо команд, прописали:

    sudo crontab -e 

![image](https://github.com/user-attachments/assets/b931d29b-5709-4c4e-ac06-318725ab76dd)

В открывшийся файл добавили строку, которая отвечает за ежедневный бэкап файлов в 2.00:

      0 3 * * * /usr/bin/pg_dump -U postgres postgres > /var/lib/postgresql/db_$(date +\%Y\%m\%d).sql && find /var/lib/postgresql -name "*.sql" -mtime +7 -delete

- ```0 3 * * *```  - время, когда будет выполняться команда
- ```/usr/bin/pg_dump``` - путь к утилите pg_dump
- ```-U postgres``` - флаг для указания пользователя PostgreSQL, от имени которого будет происходить копирование
- ```postgres``` - имя базы данных, которую будем сохранять
- ```> /var/lib/postgresql/db_$(date +\%Y\%m\%d).sql``` - путь и название файла, в который бужет сохраняться копия базы
- ```&&```
Логический оператор "И". Вторая команда (find) выполнится только если первая (pg_dump) завершится успешно (код возврата 0).
- ```find /var/lib/postgresql```
Ищет файлы в директории /backups.
- ```-name "*.sql"```
Фильтр: только файлы с расширением .sql.
- ```-mtime +7```
Фильтр по времени: файлы, изменённые более 7 дней назад.
- ```-delete```
Удаляет найденные файлы.


# 6. Мониторинг состояния системы 
### Использовать стандартные инструменты Debian (например, top, htop, iotop) для мониторинга потребления ресурсов PostgreSQL (CPU, RAM, IO). Уметь объяснить все значения выводимых показателей. 


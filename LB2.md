**Лабораторная работа №2: резервное копирование, восстановление и 
мониторинг в Debian и PostgreSQL** 

Изучить способы резервного копирования баз данных PostgreSQL и восстановления 
их в среде Debian. Освоить базовые инструменты мониторинга системы и сервиса 
PostgreSQL. 

# 1. Утилиты резервного копирования 
### Изучить и сравнить pg_dump и pg_basebackup. Описать сценарии применения каждой утилиты.

pg_dump: Логический бэкап (SQL), отдельных БД/таблиц, медленное восстановление, межверсионная совместимость. Утилита для создания логических дампов отдельных баз данных PostgreSQL. Она извлекает данные в виде SQL-команд, которые можно выполнить для восстановления базы.

pg_basebackup: Физический бэкап (бинарный), всего кластера, быстрое восстановление, только для той же версии. Утилита для создания физических бэкапов всего кластера PostgreSQL (всех баз данных). Она копирует бинарные файлы данных с сервера, создавая полную копию на момент бэкапа.

**Когда использовать?**

pg_dump:
 - Бэкап отдельных БД/таблиц
 - Перенос между версиями PostgreSQL
 - Экспорт структуры без данных
 - Малые/средние БД

pg_basebackup:
 - Полный бэкап кластера
 - Настройка репликации
 - Быстрое восстановление (Disaster Recovery)
 - Развертывание идентичных сред
 - Требует соответсвующих прав от пользователя ```CREATE USER backup_user WITH REPLICATION LOGIN PASSWORD 'secure_password';```

# 2. Создание резервной копии 
### Выполнить полное резервное копирование (dump) базы данных из лаб. №1. Использовать параметры (например, -Fc, -Ft, обязательно посмотреть другие параметры!), объяснить разницу. 

Plain (текстовый SQL) – -Fp (по умолчанию)
- Вывод в виде читаемого SQL-скрипта
- Нет сжатия (размер бэкапа ≈ размеру данных в БД)
- Можно редактировать вручную перед восстановлением
- Подходит для мелких БД или переноса между разными версиями PostgreSQL
  
        pg_dump -U user -d dbname -Fp -f backup.sql

Custom (бинарный) – -Fc
- Бинарный формат со сжатием (экономит место)
- Поддержка параллельного восстановления (pg_restore -j N)
- Возможность выборочного восстановления объектов
- Самый быстрый для больших БД

        pg_dump -U user -d dbname -Fc -f backup.dump

Directory (каталог) – -Fd

 - Создает каталог с отдельными файлами для каждой таблицы
 - Поддержка многопоточности при дампе (-j N)
 - Автоматическое сжатие (как в Custom)
 - Удобен для частичного восстановления

         pg_dump -U user -d dbname -Fd -f backup_dir/

Tar (архив) – -Ft
 - Создает .tar-архив (можно распаковать стандартными утилитами)
 - Каждая таблица – отдельный файл в архиве
 - Поддержка сжатия через -Z (gzip) или --compress=0-9
 - Ограничение: размер файла не должен превышать 8 GB
   
       pg_dump -U user -d dbname -Ft -f backup.tar
   
![image](https://github.com/user-attachments/assets/000aa149-2bd0-4734-a3dd-7ddb958238de)

Для создания полной копии БД будем использовать команду

    pg_dump -U postgres -d postgres -Fp -f backup.sql

![image](https://github.com/user-attachments/assets/1974f3c3-b228-4510-ae32-5e1a0137f131)
![image](https://github.com/user-attachments/assets/75bd187c-e585-496a-9d5b-77dd0559cfc4)


Т.к. точной директории при создании дамба я не указала, файл бэкапа сохраниться в ```/home/username/backup.sql.``` 

Команда для восстановления:

    psql -U user -d new_dbname -f backup.sql

# 3. Частичное (выборочное) резервное копирование 
### Сделать дамп только определённой схемы (например, test_schema, созданной в ЛР №1). Сделать дамп только определённых таблиц из схемы public. Объяснить, в чём отличие от резервного копирования всей базы.    

Для резервного копирования отдельных схем или таблиц используется ```pg_dump``` с параметрами выбора объектов. Это отличается от полного бэкапа базы ```(pg_dump -d dbname)``` тем, что сохраняются только указанные данные, что экономит место и время.

![image](https://github.com/user-attachments/assets/2f343eab-cce4-47f7-8ca1-14b5e6a5dd89)
![image](https://github.com/user-attachments/assets/7ba767da-3217-4d26-8c5d-bde908befd2e)
![image](https://github.com/user-attachments/assets/8c70596e-b931-42ba-aed5-2bad0a617040)

Скопируем только схему test_schema, созраняя данные внутри нее при помощи:

    pg_dump -U postgres -d postgres -n test_schema -Fc -f test_schema.dump

 + -U postgres - делаем копирование от имени пользователя postgres
 + -d postgres - копируем схему из бд postgres
 + -n test_schema — дамп только схемы test_schema
 + -Fc — бинарный формат (используем только его, т.к. в лабораторной работе есть пунктик о восстановлении определенной таблицы, и именно данный режим наиболее удобен для точечноговосстановления элементов)
 + -f test_schema.dump — сохранение в файл

Скопируем таблицу test из схемы public при помощи команды:

    pg_dump -U postgres -d postgres -t public.test -Fc -f public-test.dump

Для восстановления одной таблицы можно использовать:

    pg_restore -U postgres -d restored_db -t test public-test.dump

 ![image](https://github.com/user-attachments/assets/2b5e3cdb-6361-455e-9ea1-76cd63fc3ae9)


# 4. Восстановление из резервной копии 
### Восстановить базу из резервного файла с помощью pg_restore или утилиты psql. Продемонстрировать процесс и результаты. 

Перед восстановлением базы обязательно нужно создать пустую БД, в которую вудет все записано

      psql -U postgres -c "CREATE DATABASE restored_db;"

Для восстановления базы можно использовать одну из двух команд:
- pg_restore. Подходит для восстановления бинарных дампов (-Fc  или  -Fd )
- psql -f. Для восстановления из текстовых SQL-дампов (-Fp)
  
![image](https://github.com/user-attachments/assets/80d55245-fd83-4c3e-9e05-7ce7dbaf5690)

Т.к. бэкап базы делали при помощи -Fp, восстанавливать будем командой:

    psql -U postgres -d restored_db -f backup.sql


# 5. Автоматизация бэкапов с помощью cron 
### Настроить планировщик cron на Debian, чтобы ежедневно создавать резервные копии. Указать, куда складываются дампы, и как выполняется ротация. Обязательно понимать, что такое ротация!     

